(function(){var t,e,i,n=[].slice,r=function(t,e){return function(){return t.apply(e,arguments)}},s=function(t,e){function i(){this.constructor=t}for(var n in e)h.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},h={}.hasOwnProperty;e={STRING_TEMPLATE_REGEXP:/\{{1,2}\s+?([a-z0-9\.]+)\s+?\}{1,2}/gi,formatters:{call:function(){var t,e;return e=arguments[0],t=2<=arguments.length?n.call(arguments,1):[],e.call.apply(e,[this].concat(n.call(t)))}},handler:function(t,e,i){return this?this.call(i.view.models,e,e.target,i.view.models):void 0},bind:function(t,i){var n;return null==i&&(i={}),n=new e.View(t,i),n.bind(),n}},t=e.Observer=function(){function t(t){this.callbacks=null!=t?t:{}}return t.prototype.observe=function(t,e,i){var n,r,s,h,o,u,l,a,p,d,c,f;if(this.obj=t,this.keypath||(this.keypath=e),u=e.split("."),o=u.pop(),a=u.join("."),p=this.walkObjectKeypath(this.obj,a),r=null!=(n=this.callbacks)[e]?n[e]:n[e]=[],i&&r.push(i),p||(p=this.walkObjectKeypath(this.obj,a,{}),this.observe(this.obj,a)),f=p[o],Object.defineProperty(p,o,{enumerable:!0,configurable:!0,get:function(){return f},set:function(t){return function(i){var n,r,s,h;if(f!==i){f=i,s=t.callbacks,h=[];for(o in s)n=s[o],o.indexOf(e)>-1?h.push(function(){var t,e,i,n;for(i=this.callbacks[o],n=[],t=0,e=i.length;e>t;t++)r=i[t],this.observe(this.obj,o),n.push(r());return n}.call(t)):h.push(void 0);return h}}}(this)}),Array.isArray(f)){for(d=["push","pop","shift","unshift","sort","reverse","splice"],c=[],h=0,l=d.length;l>h;h++)s=d[h],c.push(function(t){return function(t){return f[s]=function(){var e,i,n,s;for(s=t.apply(f,arguments),i=0,n=r.length;n>i;i++)(e=r[i])();return s}}}(this)(f[s]));return c}},t.prototype.get=function(){return this.walkObjectKeypath.call(this,this.obj,this.keypath)},t.prototype.set=function(t){return this.walkObjectKeypath.call(this,this.obj,this.keypath,t)},t.prototype.walkObjectKeypath=function(t,e,i){var n,r,s,h,o,u;if(null==t&&(t={}),u=t,e&&(s=e.split("."),h=s.slice(-1)[0],s.length))for(n=0,o=s.length;o>n;n++)r=s[n],u=r===h?i||i===!1||""===i?u[r]=i:null!=u[r]?u[r]:null:null!=u[r]?u[r]:{};return u},t}(),e.View=function(){function t(t,i,n){this.els=t,this.models=i,this.callbacks=null!=n?n:{},this.update=r(this.update,this),this.publish=r(this.publish,this),this.unbind=r(this.unbind,this),this.bind=r(this.bind,this),this.select=r(this.select,this),this.traverse=r(this.traverse,this),this.build=r(this.build,this),this.buildBinding=r(this.buildBinding,this),this.bindingRegExp=r(this.bindingRegExp,this),this.els instanceof Array||(this.els=[this.els]),this.binders=e.binders,this.build()}return t.prototype.bindingRegExp=function(){return new RegExp("^cb-")},t.prototype.buildBinding=function(t,i,n,r){var s,h,o,u,l;return l=function(){var t,e,i,n;for(i=r.match(/((?:'[^']*')*(?:(?:[^\|']+(?:'[^']*')*[^\|']*)+|[^\|]+))|^$/g),n=[],t=0,e=i.length;e>t;t++)u=i[t],n.push(u.trim());return n}(),s=function(){var t,e,i,n;for(i=l.shift().split("<"),n=[],t=0,e=i.length;e>t;t++)h=i[t],n.push(h.trim());return n}(),o=s.shift(),this.bindings.push(new e[t](this,i,n,o))},t.prototype.build=function(){var t,i,n,r,s;for(this.bindings=[],r=function(t){return function(i){var n,s,h,o,u,l,a,p,d,c,f,b,v;if(3===i.nodeType){if(p=e.TextTemplateParser,(v=p.parse(i.data)).length&&(1!==v.length||v[0].type!==p.types.text)){for(h=0,u=v.length;u>h;h++)b=v[h],f=document.createTextNode(b.value),i.parentNode.insertBefore(f,i),1===b.type&&t.buildBinding("TextBinding",f,null,b.value);i.parentNode.removeChild(i)}}else 1===i.nodeType&&(n=t.traverse(i));if(!n){for(d=function(){var t,e,n,r;for(n=i.childNodes,r=[],t=0,e=n.length;e>t;t++)a=n[t],r.push(a);return r}(),c=[],o=0,l=d.length;l>o;o++)s=d[o],c.push(r(s));return c}}}(this),s=this.els,i=0,n=s.length;n>i;i++)t=s[i],r(t);return this.bindings.sort(function(t,e){var i,n;return((null!=(i=e.binder)?i.priority:void 0)||0)-((null!=(n=t.binder)?n.priority:void 0)||0)})},t.prototype.traverse=function(t){var e,i,n,r,s,h,o,u,l,a,p,d,c,f,b,v;for(r=this.bindingRegExp(),s="SCRIPT"===t.nodeName||"STYLE"===t.nodeName,p=t.attributes,h=0,l=p.length;l>h;h++)if(e=p[h],r.test(e.name)){if(b=e.name.replace(r,""),!(n=this.binders[b])){d=this.binders;for(o in d)v=d[o],"*"!==o&&-1!==o.indexOf("*")&&(f=new RegExp("^"+o.replace(/\*/g,".+")+"$"),f.test(b)&&(n=v))}n||(n=this.binders["*"]),n.block&&(s=!0,i=[e])}for(c=i||t.attributes,u=0,a=c.length;a>u;u++)e=c[u],r.test(e.name)&&(b=e.name.replace(r,""),this.buildBinding("Binding",t,b,e.value));return s},t.prototype.select=function(t){var e,i,n,r,s;for(r=this.bindings,s=[],i=0,n=r.length;n>i;i++)e=r[i],t(e)&&s.push(e);return s},t.prototype.bind=function(){var t,e,i,n,r;for(n=this.bindings,r=[],e=0,i=n.length;i>e;e++)t=n[e],r.push(t.bind());return r},t.prototype.unbind=function(){var t,e,i,n,r;for(n=this.bindings,r=[],e=0,i=n.length;i>e;e++)t=n[e],r.push(t.unbind());return r},t.prototype.publish=function(){var t,e,i,n,r;for(n=this.select(function(t){var e;return null!=(e=t.binder)?e.publishes:void 0}),r=[],e=0,i=n.length;i>e;e++)t=n[e],r.push(t.publish());return r},t.prototype.update=function(t){var e,i,n,r,s,h,o;null==t&&(t={});for(n in t)s=t[n],this.models[n]=s;for(h=this.bindings,o=[],i=0,r=h.length;r>i;i++)e=h[i],o.push("function"==typeof e.update?e.update(t):void 0);return o},t}(),e.TypeParser=function(){function t(){}return t.types={primitive:0,keypath:1},t.parse=function(t){return/^'.*'$|^".*"$/.test(t)?{type:this.types.primitive,value:t.slice(1,-1)}:"true"===t?{type:this.types.primitive,value:!0}:"false"===t?{type:this.types.primitive,value:!1}:"null"===t?{type:this.types.primitive,value:null}:"undefined"===t?{type:this.types.primitive,value:void 0}:""===t?{type:this.types.primitive,value:void 0}:isNaN(Number(t))===!1?{type:this.types.primitive,value:Number(t)}:{type:this.types.keypath,value:t}},t}(),e.TextTemplateParser=function(){function t(){}return t.types={text:0,binding:1},t.parse=function(t){var i;return(null!=(i=t.match(e.STRING_TEMPLATE_REGEXP))?i:[]).map(function(t){return function(e){return{type:t.types.text,value:e}}}(this))},t}(),e.Binding=function(){function i(t,e,i,n){this.view=t,this.el=e,this.type=i,this.keypath=n,this.getValue=r(this.getValue,this),this.update=r(this.update,this),this.unbind=r(this.unbind,this),this.bind=r(this.bind,this),this.publish=r(this.publish,this),this.sync=r(this.sync,this),this.set=r(this.set,this),this.eventHandler=r(this.eventHandler,this),this.formattedValue=r(this.formattedValue,this),this.observe=r(this.observe,this),this.setBinder=r(this.setBinder,this),this.formatters=[],this.formatterObservers={},this.callbacks=this.view.callbacks||{},this.setBinder()}return i.prototype.setBinder=function(){var t,e,i,n;if(!(this.binder=this.view.binders[this.type])){e=this.view.binders;for(t in e)n=e[t],"*"!==t&&-1!==t.indexOf("*")&&(i=new RegExp("^"+t.replace(/\*/g,".+")+"$"),i.test(this.type)&&(this.binder=n,this.args=new RegExp("^"+t.replace(/\*/g,"(.+)")+"$").exec(this.type),this.args.shift()))}return this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function?this.binder={routine:this.binder}:void 0},i.prototype.observe=function(e,i,n){var r;return r=new t(this.callbacks),r.observe.apply(r,arguments),r},i.prototype.formattedValue=function(t){var i,r,s,h,o,u,l,a,p,d,c,f,b,v,y;for(v=this.formatters,o=l=0,d=v.length;d>l;o=++l){for(u=v[o],s=u.match(/[^\s']+|'([^']|'[^\s])*'|"([^"]|"[^\s])*"/g),a=s.shift(),u=this.view.formatters[a],s=function(){var t,i,n;for(n=[],t=0,i=s.length;i>t;t++)r=s[t],n.push(e.TypeParser.parse(r));return n}(),b=[],i=p=0,c=s.length;c>p;i=++p)r=s[i],b.push(0===r.type?r.value:((h=this.formatterObservers)[o]||(h[o]={}),(f=this.formatterObservers[o][i])?void 0:(f=this.observe(this.view.models,r.value,this.sync),this.formatterObservers[o][i]=f),f.value()));(null!=u?u.read:void 0)instanceof Function?t=(y=u.read).call.apply(y,[this.view.models,t].concat(n.call(b))):u instanceof Function&&(t=u.call.apply(u,[this.view.models,t].concat(n.call(b))))}return t},i.prototype.eventHandler=function(t){return function(i){return function(n){return e.handler.call(t,i,n,i)}}(this)},i.prototype.set=function(t){var e;return null!=(e=this.binder.routine)?e.call(this,this.el,this.formattedValue(t)):void 0},i.prototype.sync=function(){return this.set(this.observer?this.observer.get():void 0)},i.prototype.publish=function(){var t,e,i,r,s,h,o,u,l;if(this.observer){for(l=this.getValue(this.el),h=this.formatters.slice(0).reverse(),i=0,s=h.length;s>i;i++)e=h[i],t=e.split(/\s+/),r=t.shift(),(null!=(o=this.view.formatters[r])?o.publish:void 0)&&(l=(u=this.view.formatters[r]).publish.apply(u,[l].concat(n.call(t))));return this.observer.set(l)}},i.prototype.bind=function(){var t,i;return i=e.TypeParser.parse(this.keypath),0===i.type?this.value=i.value:this.observer=this.observe(this.view.models,this.keypath,this.sync),null!=(t=this.binder.bind)&&t.call(this,this.el),this.sync()},i.prototype.unbind=function(){var t;return null!=(t=this.binder.unbind)&&t.call(this,this.el),this.formatterObservers={},delete this.observer},i.prototype.update=function(t){var e;return null==t&&(t={}),null!=(e=this.binder.update)?e.call(this,t||this.sync()):void 0},i.prototype.getValue=function(t){return this.binder&&null!=this.binder.getValue?this.binder.getValue.call(this,t):this.getInputValue(t)},i.prototype.getInputValue=function(t){return"checkbox"===t.type?t.checked:t.value},i}(),e.TextBinding=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.binder={routine:function(t,e){return t.data=null!=e?e:""}},e}(e.Binding),i=e.binders={},i.text=function(t,e){return null==e&&(e=""),t.textContent?t.textContent=e:t.innerText=e},i.html=function(t,e){return"string"==typeof e?i.text(t,e):e instanceof HTMLElement?t.innerHTML=e.outerHTML:void 0},i.show=function(t,e){return t.style.display=e?"":"none"},i.hide=function(t,e){return t.style.display=e?"none":""},i.enabled=function(t,e){return t.disabled=!e},i.disabled=function(t,e){return t.disabled=!!e},i.value={publishes:!0,priority:3e3,bind:function(t){var e,i;return e=t.tagName,i=t.type,"INPUT"!==e||"radio"!==i?(this.event="SELECT"===e||"checkbox"===i?"change":"input",t.addEventListener(this.event,this.publish)):void 0},unbind:function(t){return"INPUT"!==t.tagName||"radio"!==t.type?t.removeEventListener(this.event,this.publish):void 0},routine:function(t,e){var i,n,r;return i=function(){var i;return(null!=e?e.toString():void 0)!==(null!=(i=t.value)?i.toString():void 0)?t.value=e:void 0},e=e||"",n=t.tagName,r=t.type,"INPUT"===n?"radio"===r?t.setAttribute("value",e):"checkbox"===r?t.checked=e:i():i()}},i["if"]={block:!0,priority:4e3,bind:function(t){var e,i;return null==this.marker?(e=["cb",this.type].join("-").replace("--","-"),i=t.getAttribute(e),this.marker=document.createComment(" rivets: "+this.type+" "+i+" "),this.bound=!1,t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)):void 0},unbind:function(){var t;return null!=(t=this.nested)?t.unbind():void 0},routine:function(t,i){return!!i==!this.bound?i?((this.nested=new e.View(t,this.view.models)).bind(),this.marker.parentNode.insertBefore(t,this.marker.nextSibling),this.bound=!0):(t.parentNode.removeChild(t),this.nested.unbind(),this.bound=!1):void 0},update:function(t){var e;return null!=(e=this.nested)?e.update(t):void 0}},i.unless={block:!0,priority:4e3,bind:function(t){return i["if"].bind.call(this,t)},unbind:function(){return i["if"].unbind.call(this)},routine:function(t,e){return i["if"].routine.call(this,t,!e)},update:function(t){return i["if"].update.call(this,t)}},i["on-*"]={"function":!0,priority:1e3,unbind:function(t){return this.handler?t.removeEventListener(this.args[0],this.handler):void 0},routine:function(t,e){return this.handler&&t.removeEventListener(this.args[0],this.handler),t.addEventListener(this.args[0],this.handler=this.eventHandler(e))}},i["each-*"]={block:!0,priority:4e3,bind:function(t){var e,i,n,r,s,h;if(null==this.marker)return e=["cb",this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t);for(r=this.iterated,s=[],i=0,n=r.length;n>i;i++)h=r[i],s.push(h.bind());return s},unbind:function(t){var e,i,n,r,s;if(null!=this.iterated){for(n=this.iterated,r=[],e=0,i=n.length;i>e;e++)s=n[e],r.push(s.unbind());return r}},routine:function(t,i){var n,r,s,h,o,u,l,a,p,d,c,f,b,v,y,g;for(d=this.args[0],i=i||[];this.iterated.length>i.length;)g=this.iterated.pop(),g.unbind(),this.marker.parentNode.removeChild(g.els[0]);for(h=s=0,l=i.length;l>s;h=++s){p=i[h],r={index:h},r["%"+d+"%"]=h,r[d]=p,f=this.view.models;for(u in f)p=f[u],null==r[u]&&(r[u]=p);this.iterated[h]?(g=new e.View(this.iterated[h].els[0],r),this.iterated[h].unbind(),this.iterated[h]=g):(y=t.cloneNode(!0),g=new e.View(y,r),c=this.iterated[h-1]?this.iterated[h-1].els[0]:this.marker,this.marker.parentNode.insertBefore(y,c.nextSibling),this.iterated.push(g)),g.bind()}if("OPTION"===t.nodeName){for(b=this.view.bindings,v=[],o=0,a=b.length;a>o;o++)n=b[o],n.el===this.marker.parentNode&&"value"===n.type?v.push(n.sync()):v.push(void 0);return v}}},i["class-*"]=function(t,e){var i;return i=" "+t.className+" ",!e==(-1!==i.indexOf(" "+this.args[0]+" "))?t.className=e?t.className+" "+this.args[0]:i.replace(" "+this.args[0]+" "," ").trim():void 0},i["no-class-*"]=function(t,e){return i["class-*"].call(this,t,!e)},i["*"]=function(t,e){return null!=e?t.setAttribute(this.type,e):t.removeAttribute(this.type)},module.exports=e}).call(this);