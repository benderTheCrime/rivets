(function(){var t,e,i,n=[].slice,r=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1},s=function(t,e){return function(){return t.apply(e,arguments)}},o=function(t,e){function i(){this.constructor=t}for(var n in e)h.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},h={}.hasOwnProperty;e={STRING_TEMPLATE_REGEXP:/\{{1,2}\s+?([a-z0-9\.]+)\s+?\}{1,2}/gi,formatters:{call:function(){var t,e;return e=arguments[0],t=2<=arguments.length?n.call(arguments,1):[],e.call.apply(e,[this].concat(n.call(t)))}},iterationAlias:function(t){return"%"+t+"%"},handler:function(t,e,i){return this.call(i.view.models.scope,e,t)},bind:function(t,i,n){var r;return null==i&&(i={}),null==n&&(n={}),r=new e.View(t,i,n),r.bind(),r}},t=function(){function t(){this.id="_",this.counter=0,this.weakmap={}}return t.prototype.observe=function(t,e,i){var n,s,o,h,l;return this.obj=t,this.keypath=e,n=this.weakReference(t).callbacks,l=this.walkObjectKeyPath(t,e),o=e.split("."),s=o.pop(),o=o.join("."),h=this.walkObjectKeyPath(t,o),null==n[e]&&(n[e]=[]),delete h[s],Object.defineProperty(h,s,{enumerable:!0,configurable:!0,get:function(){return l},set:function(r){return function(s){var o,h,u,a,d;if(s!==l){for(l=s,r.observe(t,e,i),a=n[e],d=[],h=0,u=a.length;u>h;h++)o=a[h],d.push(o());return d}}}(this)}),r.call(n[e],i)<0&&n[e].push(i),this.observeMutations(l,t[this.id],s)},t.prototype.weakReference=function(t){var e,i,n;return t.hasOwnProperty(this.id)||(i=this.counter++,Object.defineProperty(t,this.id,{value:i})),(e=this.weakmap)[n=t[this.id]]||(e[n]={callbacks:{}})},t.prototype.observeMutations=function(t,e,i){var n,s,o,h,l,u;if(Array.isArray(t)){if(u=this.weakReference(t),null==u.pointers)for(u.pointers={},o=["push","pop","shift","unshift","sort","reverse","splice"],h=0,l=o.length;l>h;h++)s=o[h],this.stubFunction(t,s);if(null==(n=u.pointers)[e]&&(n[e]=[]),r.call(u.pointers[e],i)<0)return u.pointers[e].push(i)}},t.prototype.stubFunction=function(t,e){var i,n,r;return n=t[e],i=this.weakReference(t),r=this.weakmap,t[e]=function(){var e,s,o,h,l,u,a,d,p,c;c=n.apply(t,arguments),u=i.pointers;for(l in u)for(o=u[l],p=null!=(a=null!=(d=r[l])?d.callbacks[o]:void 0)?a:[],s=0,h=p.length;h>s;s++)(e=p[s])();return c}},t.prototype.get=function(){return this.walkObjectKeyPath.call(this,this.obj,this.keypath)},t.prototype.set=function(t){return this.walkObjectKeyPath.call(this,this.obj,this.keypath,t)},t.prototype.walkObjectKeyPath=function(t,e,i){var n,r,s,o,h,l,u;for(s=e.split("."),o=s.reverse()[0],u=t,l=s.reverse(),n=0,h=l.length;h>n;n++)r=l[n],r===o&&i?u=u[r]=i:null!=u[r]&&(u=u[r]);return u},t}(),e.adapters={".":new t},e.adapters["."]="_cb",e.View=function(){function t(t,i,n){this.els=t,this.models=i,null==n&&(n={}),this.publish=s(this.publish,this),this.unbind=s(this.unbind,this),this.bind=s(this.bind,this),this.select=s(this.select,this),this.traverse=s(this.traverse,this),this.build=s(this.build,this),this.buildBinding=s(this.buildBinding,this),this.bindingRegExp=s(this.bindingRegExp,this),this.els instanceof Array||(this.els=[this.els]),this.binders=e.binders,this.build()}return t.prototype.bindingRegExp=function(){return new RegExp("^cb-")},t.prototype.buildBinding=function(t,i,n,r){var s,o,h,l,u,a,d;return u={},d=function(){var t,e,i,n;for(i=r.match(/((?:'[^']*')*(?:(?:[^\|']+(?:'[^']*')*[^\|']*)+|[^\|]+))|^$/g),n=[],t=0,e=i.length;e>t;t++)a=i[t],n.push(a.trim());return n}(),s=function(){var t,e,i,n;for(i=d.shift().split("<"),n=[],t=0,e=i.length;e>t;t++)o=i[t],n.push(o.trim());return n}(),l=s.shift(),u.formatters=d,(h=s.shift())&&(u.dependencies=h.split(/\s+/)),this.bindings.push(new e[t](this,i,n,l,u))},t.prototype.build=function(){var t,i,n,r,s;for(this.bindings=[],r=function(t){return function(i){var n,s,o,h,l,u,a,d,p,c,f,v;if(3===i.nodeType){if(d=e.TextTemplateParser,(v=d.parse(i.data)).length&&(1!==v.length||v[0].type!==d.types.text)){for(o=0,l=v.length;l>o;o++)f=v[o],c=document.createTextNode(f.value),i.parentNode.insertBefore(c,i),1===f.type&&t.buildBinding("TextBinding",c,null,f.value);i.parentNode.removeChild(i)}}else 1===i.nodeType&&(n=t.traverse(i));if(!n)for(p=function(){var t,e,n,r;for(n=i.childNodes,r=[],e=0,t=n.length;t>e;e++)a=n[e],r.push(a);return r}(),h=0,u=p.length;u>h;h++)s=p[h],r(s)}}(this),s=this.els,i=0,n=s.length;n>i;i++)t=s[i],r(t);this.bindings.sort(function(t,e){var i,n;return((null!=(i=e.binder)?i.priority:void 0)||0)-((null!=(n=t.binder)?n.priority:void 0)||0)})},t.prototype.traverse=function(t){var e,i,n,r,s,o,h,l,u,a,d,p,c,f,v,b;for(r=this.bindingRegExp(),s="SCRIPT"===t.nodeName||"STYLE"===t.nodeName,d=t.attributes,h=0,u=d.length;u>h;h++)if(e=d[h],r.test(e.name)){if(v=e.name.replace(r,""),!(n=this.binders[v])){p=this.binders;for(o in p)b=p[o],"*"!==o&&-1!==o.indexOf("*")&&(f=new RegExp("^"+o.replace(/\*/g,".+")+"$"),f.test(v)&&(n=b))}n||(n=this.binders["*"]),n.block&&(s=!0,i=[e])}for(c=i||t.attributes,l=0,a=c.length;a>l;l++)e=c[l],r.test(e.name)&&(v=e.name.replace(r,""),this.buildBinding("Binding",t,v,e.value));return s},t.prototype.select=function(t){var e,i,n,r,s;for(r=this.bindings,s=[],i=0,n=r.length;n>i;i++)e=r[i],t(e)&&s.push(e);return s},t.prototype.bind=function(){var t,e,i,n;for(n=this.bindings,e=0,i=n.length;i>e;e++)t=n[e],t.bind()},t.prototype.unbind=function(){var t,e,i,n;for(n=this.bindings,e=0,i=n.length;i>e;e++)t=n[e],t.unbind()},t.prototype.publish=function(){var t,e,i,n;for(n=this.select(function(t){var e;return null!=(e=t.binder)?e.publishes:void 0}),e=0,i=n.length;i>e;e++)t=n[e],t.publish()},t}(),e.TypeParser=function(){function t(){}return t.types={primitive:0,keypath:1},t.parse=function(t){return/^'.*'$|^".*"$/.test(t)?{type:this.types.primitive,value:t.slice(1,-1)}:"true"===t?{type:this.types.primitive,value:!0}:"false"===t?{type:this.types.primitive,value:!1}:"null"===t?{type:this.types.primitive,value:null}:"undefined"===t?{type:this.types.primitive,value:void 0}:""===t?{type:this.types.primitive,value:void 0}:isNaN(Number(t))===!1?{type:this.types.primitive,value:Number(t)}:{type:this.types.keypath,value:t}},t}(),e.TextTemplateParser=function(){function t(){}return t.types={text:0,binding:1},t.parse=function(t){var i;return(null!=(i=t.match(e.STRING_TEMPLATE_REGEXP))?i:[]).map(function(t){return function(e){return{type:t.types.text,value:e}}}(this))},t}(),e.Binding=function(){function t(t,e,i,n,r){this.view=t,this.el=e,this.type=i,this.keypath=n,this.options=null!=r?r:{},this.getValue=s(this.getValue,this),this.update=s(this.update,this),this.unbind=s(this.unbind,this),this.bind=s(this.bind,this),this.publish=s(this.publish,this),this.sync=s(this.sync,this),this.set=s(this.set,this),this.eventHandler=s(this.eventHandler,this),this.formattedValue=s(this.formattedValue,this),this.observe=s(this.observe,this),this.setBinder=s(this.setBinder,this),this.formatters=this.options.formatters||[],this.dependencies=[],this.formatterObservers={},this.model=void 0,this.setBinder()}return t.prototype.setBinder=function(){var t,e,i,n;if(!(this.binder=this.view.binders[this.type])){e=this.view.binders;for(t in e)n=e[t],"*"!==t&&-1!==t.indexOf("*")&&(i=new RegExp("^"+t.replace(/\*/g,".+")+"$"),i.test(this.type)&&(this.binder=n,this.args=new RegExp("^"+t.replace(/\*/g,"(.+)")+"$").exec(this.type),this.args.shift()))}return this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function?this.binder={routine:this.binder}:void 0},t.prototype.observe=function(t,i,n){var r;return r=new e.Observer,r.observe.apply(r,arguments),r},t.prototype.formattedValue=function(t){var i,r,s,o,h,l,u,a,d,p,c,f,v,b,y;for(b=this.formatters,h=a=0,p=b.length;p>a;h=++a){for(l=b[h],s=l.match(/[^\s']+|'([^']|'[^\s])*'|"([^"]|"[^\s])*"/g),u=s.shift(),l=this.view.formatters[u],s=function(){var t,i,n;for(n=[],t=0,i=s.length;i>t;t++)r=s[t],n.push(e.TypeParser.parse(r));return n}(),v=[],i=d=0,c=s.length;c>d;i=++d)r=s[i],v.push(0===r.type?r.value:((o=this.formatterObservers)[h]||(o[h]={}),(f=this.formatterObservers[h][i])?void 0:(f=this.observe(this.view.models,r.value,this.sync),this.formatterObservers[h][i]=f),f.value()));(null!=l?l.read:void 0)instanceof Function?t=(y=l.read).call.apply(y,[this.model,t].concat(n.call(v))):l instanceof Function&&(t=l.call.apply(l,[this.model,t].concat(n.call(v))))}return t},t.prototype.eventHandler=function(t){return function(i){return function(n){return e.handler.call(t,i,n,i)}}(this)},t.prototype.set=function(t){var e;return null!=(e=this.binder.routine)?e.call(this,this.el,this.formattedValue(t)):void 0},t.prototype.sync=function(){var t,e;return this.set(function(){var i,n,r,s,o,h,l;if(this.observer){if(this.model!==this.observer.target){for(o=this.dependencies,i=0,r=o.length;r>i;i++)e=o[i],e.unobserve();if(this.dependencies=[],null!=(this.model=this.observer.target)&&(null!=(h=this.options.dependencies)?h.length:void 0))for(l=this.options.dependencies,n=0,s=l.length;s>n;n++)t=l[n],e=this.observe(this.model,t,this.sync),this.dependencies.push(e)}return this.observer.get()}return this.value}.call(this))},t.prototype.publish=function(){var t,e,i,r,s,o,h,l,u;if(this.observer){for(u=this.getValue(this.el),o=this.formatters.slice(0).reverse(),r=0,s=o.length;s>r;r++)e=o[r],t=e.split(/\s+/),i=t.shift(),(null!=(h=this.view.formatters[i])?h.publish:void 0)&&(u=(l=this.view.formatters[i]).publish.apply(l,[u].concat(n.call(t))));return this.observer.set(u)}},t.prototype.bind=function(){var t,i,n,r,s,o,h,l;if(l=e.TypeParser.parse(this.keypath),0===l.type?this.value=l.value:(this.observer=this.observe(this.view.models,this.keypath,this.sync),this.model=this.observer.target),null!=(s=this.binder.bind)&&s.call(this,this.el),null!=this.model&&(null!=(o=this.options.dependencies)?o.length:void 0))for(h=this.options.dependencies,i=0,n=h.length;n>i;i++)t=h[i],r=this.observe(this.model,t,this.sync),this.dependencies.push(r);return this.sync()},t.prototype.unbind=function(){var t;return null!=(t=this.binder.unbind)&&t.call(this,this.el),this.formatterObservers={},delete this.observer.obj},t.prototype.update=function(t){var e,i;return null==t&&(t={}),this.model=null!=(e=this.observer)?e.target:void 0,null!=(i=this.binder.update)?i.call(this,t):void 0},t.prototype.getValue=function(t){return this.binder&&null!=this.binder.getValue?this.binder.getValue.call(this,t):this.getInputValue(t)},t.prototype.getInputValue=function(t){return"checkbox"===t.type?t.checked:t.value},t}(),e.TextBinding=function(t){function e(t,e,i,n,r){this.view=t,this.el=e,this.type=i,this.keypath=n,this.options=null!=r?r:{},this.formatters=this.options.formatters||[],this.dependencies=[],this.formatterObservers={}}return o(e,t),e.prototype.binder={routine:function(t,e){return t.data=null!=e?e:""}},e}(e.Binding),i=e.binders={},i.text=function(t,e){return null!=t.textContent?t.textContent=null!=e?e:"":t.innerText=null!=e?e:""},i.html=function(t,e){return e instanceof HTMLElement&&(e=e.outerHTML),"string"==typeof(null!=e)?this.text(t,e):t.innerHTML=null!=e?e:""},i.show=function(t,e){return t.style.display=e?"":"none"},i.hide=function(t,e){return t.style.display=e?"none":""},i.enabled=function(t,e){return t.disabled=!e},i.disabled=function(t,e){return t.disabled=!!e},i.value={publishes:!0,priority:3e3,bind:function(t){return"INPUT"!==t.tagName||"radio"!==t.type?(this.event="SELECT"===t.tagName?"change":"input",t.addEventListener(this.event,this.publish)):void 0},unbind:function(t){return"INPUT"!==t.tagName||"radio"!==t.type?t.removeEventListener(this.event,this.publish):void 0},routine:function(t,e){var i,n,s,o,h,l,u;if("INPUT"===t.tagName&&"radio"===t.type)return t.setAttribute("value",e);if(null!=window.jQuery){if(t=jQuery(t),(null!=e?e.toString():void 0)!==(null!=(o=t.val())?o.toString():void 0))return t.val(null!=e?e:"")}else if("select-multiple"===t.type){if(null!=e){for(u=[],i=0,n=t.length;n>i;i++)s=t[i],u.push(s.selected=(h=s.value,r.call(e,h)>=0));return u}}else if((null!=e?e.toString():void 0)!==(null!=(l=t.value)?l.toString():void 0))return t.value=null!=e?e:""}},i["if"]={block:!0,priority:4e3,bind:function(t){var e,i;return null==this.marker?(e=["cb",this.type].join("-").replace("--","-"),i=t.getAttribute(e),this.marker=document.createComment(" rivets: "+this.type+" "+i+" "),this.bound=!1,t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)):void 0},unbind:function(){var t;return null!=(t=this.nested)?t.unbind():void 0},routine:function(t,i){var n,r,s,o;if(!!i==!this.bound){if(i){s={},o=this.view.models;for(n in o)r=o[n],s[n]=r;return(this.nested||(this.nested=new e.View(t,s,this.view.options()))).bind(),this.marker.parentNode.insertBefore(t,this.marker.nextSibling),this.bound=!0}return t.parentNode.removeChild(t),this.nested.unbind(),this.bound=!1}},update:function(t){var e;return null!=(e=this.nested)?e.update(t):void 0}},i.unless={block:!0,priority:4e3,bind:function(t){return i["if"].bind.call(this,t)},unbind:function(){return i["if"].unbind.call(this)},routine:function(t,e){return i["if"].routine.call(this,t,!e)},update:function(t){return i["if"].update.call(this,t)}},i["on-*"]={"function":!0,priority:1e3,unbind:function(t){return this.handler?t.removeEventListener(this.args[0],this.handler):void 0},routine:function(t,e){return this.handler&&t.removeEventListener(this.args[0],this.handler),t.addEventListener(this.args[0],this.handler=this.eventHandler(e))}},i["each-*"]={block:!0,priority:4e3,bind:function(t){var e,i,n,r,s;if(null==this.marker)e=["cb",this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t);else for(r=this.iterated,i=0,n=r.length;n>i;i++)s=r[i],s.bind()},unbind:function(t){var e,i,n,r;if(null!=this.iterated)for(n=this.iterated,e=0,i=n.length;i>e;e++)r=n[e],r.unbind()},routine:function(t,i){var n,r,s,o,h,l,u,a,d,p,c,f,v,b,y,g,m,w,k,N;if(f=this.args[0],i=i||[],this.iterated.length>i.length)for(g=Array(this.iterated.length-i.length),h=0,a=g.length;a>h;h++)s=g[h],N=this.iterated.pop(),N.unbind(),this.marker.parentNode.removeChild(N.els[0]);for(o=u=0,d=i.length;d>u;o=++u)if(c=i[o],r={index:o},r[e.iterationAlias(f)]=o,r[f]=c,null==this.iterated[o]){m=this.view.models;for(l in m)c=m[l],null==r[l]&&(r[l]=c);y=this.iterated.length?this.iterated[this.iterated.length-1].els[0]:this.marker,v=this.view.options(),k=t.cloneNode(!0),N=new e.View(k,r,v),N.bind(),this.iterated.push(N),this.marker.parentNode.insertBefore(k,y.nextSibling)}else this.iterated[o].models[f]!==c&&this.iterated[o].update(r);if("OPTION"===t.nodeName)for(w=this.view.bindings,b=0,p=w.length;p>b;b++)n=w[b],n.el===this.marker.parentNode&&"value"===n.type&&n.sync()},update:function(t){var e,i,n,r,s,o,h;e={};for(n in t)s=t[n],n!==this.args[0]&&(e[n]=s);for(o=this.iterated,i=0,r=o.length;r>i;i++)h=o[i],h.update(e)}},i["class-*"]=function(t,e){var i;return i=" "+t.className+" ",!e==(-1!==i.indexOf(" "+this.args[0]+" "))?t.className=e?t.className+" "+this.args[0]:i.replace(" "+this.args[0]+" "," ").trim():void 0},i["*"]=function(t,e){return null!=e?t.setAttribute(this.type,e):t.removeAttribute(this.type)},module.exports=e}).call(this);