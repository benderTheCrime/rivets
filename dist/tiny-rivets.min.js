(function(){var t,e,i,n,r,s=[].slice,o=function(t,e){return function(){return t.apply(e,arguments)}},u=function(t,e){function i(){this.constructor=t}for(var n in e)h.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},h={}.hasOwnProperty;i={STRING_TEMPLATE_REGEXP:/\{{1,2}\s*?([\w\.]+\s*?(\s*?\|\s*?\w+)*?)\s*?\}{1,2}/gi,FORMATTER_PIPE_REGEXP:/((?:'[^']*')*(?:(?:[^\|']+(?:'[^']*')*[^\|']*)+|[^\|]+))|^$/g,formatters:{call:function(){var t,e;return e=arguments[0],t=2<=arguments.length?s.call(arguments,1):[],e.call.apply(e,[this].concat(s.call(t)))}},handler:function(t,e,i){return this?this.call(i.view.models,e,e.target,i.view.models):void 0},bind:function(t,e){var i;return null==e&&(e={}),(i=new n(t,e)).bind(),i}},module.exports=e=i.Observer=function(){function t(t){this.callbacks=null!=t?t:{}}return t.prototype.observe=function(t,e,i){var n,r,s,o,u,h,l,a,d,c,p,b;if(this.obj=t,this.keypath||(this.keypath=e),h=e.split("."),u=h.pop(),a=h.join("."),d=this.walkObjectKeypath(this.obj,a),r=null!=(n=this.callbacks)[e]?n[e]:n[e]=[],i&&r.push(i),d||(d=this.walkObjectKeypath(this.obj,a,{}),this.observe(this.obj,a)),b=d[u],Object.defineProperty(d,u,{enumerable:!0,configurable:!0,get:function(){return b},set:function(t){return function(i){var n,r,s,o;if(b!==i){b=i,s=t.callbacks,o=[];for(u in s)n=s[u],u.indexOf(e)>-1?o.push(function(){var t,e,i;for(i=[],t=0,e=n.length;e>t;t++)r=n[t],this.observe(this.obj,u),i.push(r());return i}.call(t)):o.push(void 0);return o}}}(this)}),Array.isArray(b)){for(c=["push","pop","shift","unshift","sort","reverse","splice"],p=[],o=0,l=c.length;l>o;o++)s=c[o],p.push(function(t){return function(t){return b[s]=function(){var e,i,n,s;for(s=t.apply(b,arguments),i=0,n=r.length;n>i;i++)(e=r[i])();return s}}}(this)(b[s]));return p}},t.prototype.get=function(){return this.walkObjectKeypath(this.obj,this.keypath)},t.prototype.set=function(t){return this.walkObjectKeypath(this.obj,this.keypath,t)},t.prototype.walkObjectKeypath=function(t,e,i){var n;return null==t&&(t={}),null==e&&(e=""),e&&"string"==typeof e?(n=e.split(".")).reduce(function(t,e,r){var s,o;return r===n.length-1?((i||i===!1||""===i)&&(t[e]=i),null!=(s=t[e])?s:null):null!=(o=t[e])?o:{}},t):t},t}(),n=i.View=function(){function t(t,e,n){this.els=t,this.models=e,this.callbacks=null!=n?n:{},this.update=o(this.update,this),this.publish=o(this.publish,this),this.unbind=o(this.unbind,this),this.bind=o(this.bind,this),this.select=o(this.select,this),this.traverse=o(this.traverse,this),this.build=o(this.build,this),this.buildBinding=o(this.buildBinding,this),this.bindingRegExp=o(this.bindingRegExp,this),this.els instanceof Array||(this.els=[this.els]),this.binders=i.binders,this.build()}return t.prototype.bindingRegExp=function(){return new RegExp("^cb-")},t.prototype.buildBinding=function(t,e,r,o){return this.bindings.push(function(t,e,i){i.prototype=t.prototype;var n=new i,r=t.apply(n,e);return Object(r)===r?r:n}(i[t],[this,e,r].concat(s.call(n.parseDeclaration(o))),function(){}))},t.prototype.build=function(){var t,e,i,n,r;for(this.bindings=[],n=function(t){return function(e){var i,r,s,o,u,h;if(!(1===e.nodeType?t.traverse(e):null)){for(u=function(){var t,i,n,r;for(n=e.childNodes,r=[],t=0,i=n.length;i>t;t++)o=n[t],r.push(o);return r}(),h=[],r=0,s=u.length;s>r;r++)i=u[r],h.push(n(i));return h}}}(this),r=this.els,e=0,i=r.length;i>e;e++)t=r[e],n(t);return this.bindings.sort(function(t,e){var i,n;return((null!=(i=e.binder)?i.priority:void 0)||0)-((null!=(n=t.binder)?n.priority:void 0)||0)})},t.prototype.traverse=function(t){var e,i,n,r,s,o,u,h,l,a,d,c,p,b,f,v;for(r=this.bindingRegExp(),s="SCRIPT"===t.nodeName||"STYLE"===t.nodeName,d=t.attributes,u=0,l=d.length;l>u;u++)if(e=d[u],r.test(e.name)){if(f=e.name.replace(r,""),!(n=this.binders[f])){c=this.binders;for(o in c)v=c[o],"*"!==o&&-1!==o.indexOf("*")&&(b=new RegExp("^"+o.replace(/\*/g,".+")+"$"),b.test(f)&&(n=v))}n||(n=this.binders["*"]),n.block&&(s=!0,i=[e])}for(p=i||t.attributes,h=0,a=p.length;a>h;h++)e=p[h],r.test(e.name)&&(f=e.name.replace(r,""),this.buildBinding("Binding",t,f,e.value));return s},t.prototype.select=function(t){var e,i,n,r,s;for(r=this.bindings,s=[],i=0,n=r.length;n>i;i++)e=r[i],t(e)&&s.push(e);return s},t.prototype.bind=function(){var t,e,i,n,r;for(n=this.bindings,r=[],e=0,i=n.length;i>e;e++)t=n[e],r.push(t.bind());return r},t.prototype.unbind=function(){var t,e,i,n,r;for(n=this.bindings,r=[],e=0,i=n.length;i>e;e++)t=n[e],r.push(t.unbind());return r},t.prototype.publish=function(){var t,e,i,n,r;for(n=this.select(function(t){var e;return null!=(e=t.binder)?e.publishes:void 0}),r=[],e=0,i=n.length;i>e;e++)t=n[e],r.push(t.publish());return r},t.prototype.update=function(t){var e,i,n,r,s,o,u;null==t&&(t={});for(n in t)s=t[n],this.models[n]=s;for(o=this.bindings,u=[],i=0,r=o.length;r>i;i++)e=o[i],u.push("function"==typeof e.update?e.update(t):void 0);return u},t.parseDeclaration=function(t){var e,n;return e=function(){var e,r,s,o;for(s=t.match(i.FORMATTER_PIPE_REGEXP),o=[],e=0,r=s.length;r>e;e++)n=s[e],o.push(n.trim());return o}(),[e.shift(),e]},t}(),i.TypeParser=function(){function t(){}return t.parse=function(t){var e;return e={type:0,value:void 0},/^'.*'$|^".*"$/.test(t)?e.value=t.slice(1,-1):"true"===t?e.value=!0:"false"===t?e.value=!1:"null"===t?e.value=null:isNaN(Number(t))===!1?e.value=Number(t):"undefined"!==t&&""!==t&&(e.type=1,e.value=t),e},t}(),t=i.Binding=function(){function r(t,e,i,n,r){var s,u,h,l;if(this.view=t,this.el=e,this.type=i,this.keypath=n,this.formatters=r,this.getValue=o(this.getValue,this),this.update=o(this.update,this),this.unbind=o(this.unbind,this),this.bind=o(this.bind,this),this.publish=o(this.publish,this),this.sync=o(this.sync,this),this.set=o(this.set,this),this.eventHandler=o(this.eventHandler,this),this.templatedValue=o(this.templatedValue,this),this.observe=o(this.observe,this),this.callbacks=this.view.callbacks||{},!(this.binder=this.view.binders[this.type])){u=this.view.binders;for(s in u)l=u[s],"*"!==s&&-1!==s.indexOf("*")&&(h=new RegExp("^"+s.replace(/\*/g,".+")+"$"),h.test(this.type)&&(this.binder=l,this.args=new RegExp("^"+s.replace(/\*/g,"(.+)")+"$").exec(this.type),this.args.shift()))}this.binder||(this.binder=this.view.binders["*"]),this.binder instanceof Function&&(this.binder={routine:this.binder})}return r.prototype.observe=function(t,i,n){var r,s;return(s=r=new e(this.callbacks)).observe.apply(s,arguments),r},r.prototype.templatedValue=function(e){var r,s,o,u,h,l,a,d;if(e&&"string"==typeof e&&this.observer)for(a=null!=(l=e.match(i.STRING_TEMPLATE_REGEXP))?l:[],o=0,h=a.length;h>o;o++)r=a[o],d=n.parseDeclaration(r.replace(/[\{\}]/g,"")),u=d[0],s=d[1],e=e.replace(r,t.formattedValue(this.observer.walkObjectKeypath(this.observer.obj,u)||"",s)),this.observer.observe(this.observer.obj,u,this.sync);return t.formattedValue(e,this.formatters)},r.prototype.eventHandler=function(t){return function(e){return function(n){return i.handler.call(t,e,n,e)}}(this)},r.prototype.set=function(t){var e;return null!=(e=this.binder.routine)?e.call(this,this.el,this.templatedValue(t)):void 0},r.prototype.sync=function(){return this.set(this.observer?this.observer.get():void 0)},r.prototype.publish=function(){var t,e,i,n,r,s,o;if(this.observer){for(o=this.getValue(this.el),s=this.formatters.slice(0).reverse(),n=0,r=s.length;r>n;n++)e=s[n],t=e.split(/\s+/),i=t.shift();return this.observer.set(o)}},r.prototype.bind=function(){var t,e;return e=i.TypeParser.parse(this.keypath),0===e.type?this.value=e.value:this.observer=this.observe(this.view.models,this.keypath,this.sync),null!=(t=this.binder.bind)&&t.call(this,this.el),this.sync()},r.prototype.unbind=function(){var t;return null!=(t=this.binder.unbind)&&t.call(this,this.el),delete this.observer},r.prototype.update=function(t){var e;return null==t&&(t={}),null!=(e=this.binder.update)?e.call(this,t||this.sync()):void 0},r.prototype.getValue=function(t){return this.binder&&null!=this.binder.getValue?this.binder.getValue.call(this,t):this.getInputValue(t)},r.prototype.getInputValue=function(t){return"checkbox"===t.type?t.checked:t.value},r.formattedValue=function(t,e){var n,r,s,o,u,h;for(r=u=0,h=e.length;h>u;r=++u)s=e[r],n=s.match(/[^\s']+|'([^']|'[^\s])*'|"([^"]|"[^\s])*"/g),o=n.shift(),s=i.formatters[o],s instanceof Function&&(t=s(t||""));return t},r}(),i.TextBinding=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return u(e,t),e.prototype.binder={routine:function(t,e){return t.data=null!=e?e:""}},e}(i.Binding),r=i.binders={},r.text=function(t,e){return null==e&&(e=""),t[t.textContent?"textContent":"innerText"]=e},r.html={priority:4e3,routine:function(t,e){return"string"==typeof e?r.text(t,e):e instanceof HTMLElement?(this.nested=new i.View(e,this.view.models,this.view.callbacks),this.nested.bind(),t.appendChild(e)):void 0},unbind:function(t){var e,i,n,r,s;if(this.nested&&"function"==typeof this.nested.unbind){for(this.nested.unbind(),r=this.nested.els,s=[],i=0,n=r.length;n>i;i++)e=r[i],s.push(t.removeChild(e));return s}}},r.show=function(t,e){return t.style.display=e?"":"none"},r.hide=function(t,e){return t.style.display=e?"none":""},r.enabled=function(t,e){return t.disabled=!e},r.disabled=function(t,e){return t.disabled=!!e},r.value={publishes:!0,priority:3e3,bind:function(t){var e,i;return e=t.tagName,i=t.type,"INPUT"!==e||"radio"!==i?(this.event="SELECT"===e||"checkbox"===i?"change":"input",t.addEventListener(this.event,this.publish)):void 0},unbind:function(t){return"INPUT"!==t.tagName||"radio"!==t.type?t.removeEventListener(this.event,this.publish):void 0},routine:function(t,e){var i,n,r;return null==e&&(e=""),i=function(){var i;return(null!=e?e.toString():void 0)!==(null!=(i=t.value)?i.toString():void 0)?t.value=e:void 0},n=t.tagName,r=t.type,"INPUT"===n?"radio"===r?t.setAttribute("value",e):"checkbox"===r?t.checked=e:i():i()}},r["if"]={block:!0,priority:5e3,bind:function(t){var e,i;return null==this.marker?(e=["cb",this.type].join("-").replace("--","-"),i=t.getAttribute(e),this.marker=document.createComment(" rivets: "+this.type+" "+i+" "),this.bound=!1,t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t)):void 0},unbind:function(){var t;return null!=(t=this.nested)?t.unbind():void 0},routine:function(t,e){return!!e==!this.bound?e?((this.nested=new i.View(t,this.view.models,this.view.callbacks)).bind(),this.marker.parentNode.insertBefore(t,this.marker.nextSibling),this.bound=!0):(t.parentNode.removeChild(t),this.nested.unbind(),this.bound=!1):void 0},update:function(t){var e;return null!=(e=this.nested)?e.update(t):void 0}},r.unless={block:!0,priority:5e3,bind:function(t){return r["if"].bind.call(this,t)},unbind:function(){return r["if"].unbind.call(this)},routine:function(t,e){return r["if"].routine.call(this,t,!e)},update:function(t){return r["if"].update.call(this,t)}},r["on-*"]={"function":!0,priority:1e3,unbind:function(t){return this.handler?t.removeEventListener(this.args[0],this.handler):void 0},routine:function(t,e){return this.handler&&t.removeEventListener(this.args[0],this.handler),t.addEventListener(this.args[0],this.handler=this.eventHandler(e))}},r["each-*"]={block:!0,priority:4e3,bind:function(t){var e,i,n,r,s,o;if(null==this.marker)return e=["cb",this.type].join("-").replace("--","-"),this.marker=document.createComment(" rivets: "+this.type+" "),this.iterated=[],t.removeAttribute(e),t.parentNode.insertBefore(this.marker,t),t.parentNode.removeChild(t);for(r=this.iterated,s=[],i=0,n=r.length;n>i;i++)o=r[i],s.push(o.bind());return s},unbind:function(t){var e,i,n,r,s;if(null!=this.iterated){for(n=this.iterated,r=[],e=0,i=n.length;i>e;e++)s=n[e],r.push(s.unbind());return r}},routine:function(t,e){var n,r,s,o,u,h,l,a,d,c,p,b,f,v;for(d=this.args[0],e=e||[];this.iterated.length>e.length;)v=this.iterated.pop(),v.unbind(),this.marker.parentNode.removeChild(v.els[0]);for(s=o=0,h=e.length;h>o;s=++o)a=e[s],r=this.view.models,r[d]=a,this.iterated[s]?(v=new i.View(this.iterated[s].els[0],r,this.view.callbacks),this.iterated[s].unbind(),this.iterated[s]=v):(f=t.cloneNode(!0),v=new i.View(f,r,this.view.callbacks),c=this.iterated[s-1]?this.iterated[s-1].els[0]:this.marker,this.marker.parentNode.insertBefore(f,c.nextSibling),this.iterated.push(v)),v.bind(),delete r[d];if("OPTION"===t.nodeName){for(p=this.view.bindings,b=[],u=0,l=p.length;l>u;u++)n=p[u],n.el===this.marker.parentNode&&"value"===n.type?b.push(n.sync()):b.push(void 0);return b}}},r["class-*"]=function(t,e){var i;return i=" "+t.className+" ",!e==(-1!==i.indexOf(" "+this.args[0]+" "))?t.className=e?t.className+" "+this.args[0]:i.replace(" "+this.args[0]+" "," ").trim():void 0},r["no-class-*"]=function(t,e){return r["class-*"].call(this,t,!e)},r["*"]=function(t,e){return t[e?"setAttribute":"removeAttribute"](this.type,e)},module.exports=i}).call(this);